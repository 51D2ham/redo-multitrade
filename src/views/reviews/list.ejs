<%- include('../partials/header.ejs', { title: 'Manage Reviews' }) %>

<!-- Navigation -->
<nav class="flex flex-wrap gap-3 mb-8 p-4 bg-white rounded-xl shadow-sm border border-gray-100 items-center">
  <a href="/admin/v1/staff/dashboard" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100 transition">
    <i class="fa fa-home"></i> Dashboard
  </a>
  <a href="/admin/v1/products" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-50 text-gray-700 hover:bg-gray-100 transition">
    <i class="fa fa-box"></i> Products
  </a>
  <span class="px-4 py-2 rounded-lg bg-yellow-100 text-yellow-700 flex items-center gap-2">
    <i class="fa fa-star"></i> Reviews
  </span>
</nav>

<main class="container mx-auto max-w-7xl px-4 mt-8">
  <!-- Flash Messages -->
  <% if (success && success.length) { %>
    <div class="mb-6 p-4 rounded-lg border-l-4 border-green-400 bg-green-50 text-green-800 shadow-sm">
      <% success.forEach(msg => { %>
        <div class="flex items-center gap-2">
          <i class="fa fa-check-circle"></i> <%= msg %>
        </div>
      <% }) %>
    </div>
  <% } %>

  <% if (error && error.length) { %>
    <div class="mb-6 p-4 rounded-lg border-l-4 border-red-400 bg-red-50 text-red-800 shadow-sm">
      <% error.forEach(msg => { %>
        <div class="flex items-center gap-2">
          <i class="fa fa-exclamation-circle"></i> <%= msg %>
        </div>
      <% }) %>
    </div>
  <% } %>

  <!-- Header -->
  <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-4 sm:p-6 mb-8 border border-yellow-100">
    <div class="flex flex-col gap-4">
      <div class="flex flex-col sm:flex-row sm:items-center gap-4">
        <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center flex-shrink-0">
          <i class="fa fa-star text-yellow-600 text-2xl"></i>
        </div>
        <div class="min-w-0 flex-1">
          <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Review Management</h1>
          <p class="text-sm sm:text-base text-gray-600">Moderate and manage customer product reviews</p>
        </div>
        <div class="bg-white rounded-lg px-4 py-2 shadow-sm border">
          <div class="text-center">
            <div class="text-xl font-bold text-blue-600"><%= reviews.length %></div>
            <div class="text-xs text-gray-500">Total Reviews</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 mb-6 border border-gray-100">
    <form method="GET" class="flex flex-col sm:flex-row gap-3 sm:gap-4 sm:items-end">
      <div class="flex-1 min-w-0">
        <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Status</label>
        <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="all" <%= filters.status === 'all' ? 'selected' : '' %>>All Reviews</option>
          <option value="pending" <%= filters.status === 'pending' ? 'selected' : '' %>>Pending</option>
          <option value="approved" <%= filters.status === 'approved' ? 'selected' : '' %>>Approved</option>
          <option value="rejected" <%= filters.status === 'rejected' ? 'selected' : '' %>>Rejected</option>
        </select>
      </div>
      <div class="flex gap-2">
        <button type="submit" class="px-4 sm:px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2 whitespace-nowrap">
          <i class="fa fa-filter"></i> <span class="hidden sm:inline">Apply Filter</span><span class="sm:hidden">Apply</span>
        </button>
        <a href="/admin/v1/reviews" class="px-4 sm:px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition flex items-center gap-2 whitespace-nowrap">
          <i class="fa fa-refresh"></i> Clear
        </a>
      </div>
    </form>
  </div>

  <!-- Reviews List -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100">
    <% if (reviews && reviews.length > 0) { %>
      <div class="divide-y divide-gray-200">
        <% reviews.forEach((review, index) => { %>
          <div class="p-4 sm:p-6 hover:bg-gray-50 transition-colors">
            <!-- Review Header -->
            <div class="flex flex-col gap-4 mb-4">
              <div class="flex flex-col sm:flex-row sm:items-start gap-4">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                  <i class="fa fa-user text-blue-600"></i>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex flex-wrap items-center gap-2 sm:gap-3 mb-2">
                    <h3 class="font-semibold text-gray-900 break-words"><%= review.user?.fullname || 'Anonymous User' %></h3>
                    <div class="flex items-center gap-1">
                      <% for (let i = 1; i <= 5; i++) { %>
                        <% if (i <= review.rating) { %>
                          <i class="fa fa-star text-sm text-yellow-400"></i>
                        <% } else if (i - 0.5 <= review.rating) { %>
                          <i class="fa fa-star-half-alt text-sm text-yellow-400"></i>
                        <% } else { %>
                          <i class="fa fa-star text-sm text-gray-300"></i>
                        <% } %>
                      <% } %>
                    </div>
                    <span class="text-sm font-medium text-gray-700"><%= review.rating %>/5</span>
                  </div>
                  <div class="flex flex-wrap items-center gap-2 text-sm text-gray-500 mb-3">
                    <span class="whitespace-nowrap"><%= new Date(review.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %></span>
                    <span class="hidden sm:inline">â€¢</span>
                    <% if (review.product?.images && review.product.images.length > 0) { %>
                      <img src="/uploads/products/<%= review.product.images[0] %>" alt="Product" class="w-8 h-8 rounded object-cover border flex-shrink-0">
                    <% } %>
                    <a href="/admin/v1/products/<%= review.product?._id %>" class="text-blue-600 hover:text-blue-800 font-medium break-words min-w-0">
                      <%= review.product?.title || 'Unknown Product' %>
                    </a>
                  </div>
                  <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-gray-700 leading-relaxed break-words"><%= review.review %></p>
                  </div>
                </div>
                
                <!-- Status Badge (Mobile) -->
                <div class="sm:hidden">
                  <span class="px-3 py-1 text-sm font-medium rounded-full <%= review.status === 'approved' ? 'bg-green-100 text-green-800' : review.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800' %>">
                    <%= review.status ? review.status.charAt(0).toUpperCase() + review.status.slice(1) : 'Unknown' %>
                  </span>
                </div>
              </div>
              
              <!-- Status & Actions -->
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <!-- Status Badge (Desktop) -->
                <div class="hidden sm:block">
                  <span class="px-3 py-1 text-sm font-medium rounded-full <%= review.status === 'approved' ? 'bg-green-100 text-green-800' : review.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800' %>">
                    <%= review.status ? review.status.charAt(0).toUpperCase() + review.status.slice(1) : 'Unknown' %>
                  </span>
                </div>
                
                <div class="flex flex-wrap items-center gap-2">
                  <% if (review.status !== 'approved') { %>
                    <form method="POST" action="/admin/v1/reviews/<%= review._id %>/approve" class="inline">
                      <input type="hidden" name="_csrf" value="<%= locals.csrfToken || '' %>">
                      <button type="submit" class="px-3 sm:px-4 py-2 rounded-lg bg-green-50 text-green-700 hover:bg-green-100 transition-colors text-sm font-medium border border-green-200 whitespace-nowrap" title="Approve Review">
                        Approve
                      </button>
                    </form>
                  <% } %>
                  
                  <% if (review.status !== 'rejected') { %>
                    <form method="POST" action="/admin/v1/reviews/<%= review._id %>/reject" class="inline">
                      <input type="hidden" name="_csrf" value="<%= locals.csrfToken || '' %>">
                      <button type="submit" class="px-3 sm:px-4 py-2 rounded-lg bg-yellow-50 text-yellow-700 hover:bg-yellow-100 transition-colors text-sm font-medium border border-yellow-200 whitespace-nowrap" title="Reject Review">
                        Reject
                      </button>
                    </form>
                  <% } %>
                  
                  <form method="POST" action="/admin/v1/reviews/<%= review._id %>?_method=DELETE" class="inline">
                    <input type="hidden" name="_csrf" value="<%= locals.csrfToken || '' %>">
                    <button type="submit" class="px-3 sm:px-4 py-2 rounded-lg bg-red-50 text-red-700 hover:bg-red-100 transition-colors text-sm font-medium border border-red-200 whitespace-nowrap" onclick="return confirm('Are you sure you want to delete this review?')" title="Delete Review">
                      Delete
                    </button>
                  </form>
                </div>
              </div>
            </div>
            
            <!-- Review Metadata -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 text-xs text-gray-500 pt-3 border-t border-gray-100">
              <div class="flex flex-wrap items-center gap-2 sm:gap-4">
                <span class="break-all">ID: <%= review._id %></span>
                <span class="break-all">User: <%= review.user?.email || 'N/A' %></span>
                <% if (review.verified) { %>
                  <span class="flex items-center gap-1 text-green-600 whitespace-nowrap">
                    <i class="fa fa-shield-check"></i> Verified
                  </span>
                <% } %>
              </div>
              <span class="whitespace-nowrap">Updated: <%= new Date(review.updatedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) %></span>
            </div>
          </div>
        <% }) %>
      </div>
      
      <!-- Pagination -->
      <% if (pagination && pagination.total > 1) { %>
        <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-xl">
          <div class="flex items-center justify-between">
            <div class="text-sm text-gray-700">
              Showing page <%= pagination.current %> of <%= pagination.total %>
            </div>
            <div class="flex items-center gap-2">
              <% if (pagination.hasPrev) { %>
                <a href="?page=<%= pagination.current - 1 %>&status=<%= filters.status %>" class="px-3 py-1 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                  <i class="fa fa-chevron-left"></i> Previous
                </a>
              <% } %>
              <% if (pagination.hasNext) { %>
                <a href="?page=<%= pagination.current + 1 %>&status=<%= filters.status %>" class="px-3 py-1 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                  Next <i class="fa fa-chevron-right"></i>
                </a>
              <% } %>
            </div>
          </div>
        </div>
      <% } %>
    <% } else { %>
      <!-- Empty State -->
      <div class="text-center py-16">
        <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-6">
          <i class="fa fa-star text-3xl text-gray-400"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No Reviews Found</h3>
        <p class="text-gray-500 mb-6">
          <% if (filters.status !== 'all') { %>
            No reviews with status "<%= filters.status %>" found.
          <% } else { %>
            No customer reviews have been submitted yet.
          <% } %>
        </p>
        <div class="flex justify-center gap-3">
          <a href="/admin/v1/products" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
            <i class="fa fa-box"></i> View Products
          </a>
          <% if (filters.status !== 'all') { %>
            <a href="/admin/v1/reviews" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">
              <i class="fa fa-refresh"></i> Show All Reviews
            </a>
          <% } %>
        </div>
      </div>
    <% } %>
  </div>
</main>

<%- include('../partials/footer.ejs') %>