<%- include('../partials/header.ejs', { title: 'Edit Order' }) %>

<div class="min-h-screen bg-gray-50 py-6">
  <div class="max-w-4xl mx-auto px-4">
    
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-6">
      <a href="/admin/v1/order/<%- encodeURIComponent(order._id) %>" class="px-3 py-2 bg-white rounded-lg shadow-sm hover:shadow-md transition-all">
        <i class="fas fa-arrow-left mr-2"></i>Back
      </a>
      <div class="flex-1">
        <h1 class="text-xl sm:text-2xl font-bold">Order #<%- order._id.toString().slice(-8).toUpperCase() %></h1>
        <p class="text-gray-600 text-sm sm:text-base">Rs <%- (order.totalPrice || 0).toLocaleString() %> â€¢ <%- (order.totalQty || 0) %> items</p>
      </div>
      <div class="text-right">
        <span class="px-3 sm:px-4 py-2 rounded-full text-xs sm:text-sm font-medium bg-blue-100 text-blue-800">
          Order: <%- (order.status || 'pending').charAt(0).toUpperCase() + (order.status || 'pending').slice(1) %>
        </span>
      </div>
    </div>

    <!-- Flash Messages -->
    <% if (typeof success !== 'undefined' && success && success.length) { %>
      <div class="mb-4 p-3 bg-green-100 border border-green-200 text-green-800 rounded-lg">
        <i class="fas fa-check-circle mr-2"></i><%- success[0] %>
      </div>
    <% } %>
    <% if (typeof error !== 'undefined' && error && error.length) { %>
      <div class="mb-4 p-3 bg-red-100 border border-red-200 text-red-800 rounded-lg">
        <i class="fas fa-exclamation-triangle mr-2"></i><%- error[0] %>
      </div>
    <% } %>

    <!-- Items -->
    <div class="bg-white rounded-lg shadow-sm border mb-6">
      <div class="p-4 border-b">
        <h2 class="text-lg font-semibold">Items</h2>
      </div>
      <div class="divide-y" id="order-items">
        <% if (typeof processedItems !== 'undefined' && processedItems && processedItems.length > 0) { %>
          <% processedItems.forEach((item, index) => { %>
            <div class="p-4 border-l-4 <%= (item.originalItem && item.originalItem.status === 'cancelled') ? 'border-red-400 bg-red-50' : (item.originalItem && item.originalItem.status === 'delivered') ? 'border-green-400 bg-green-50' : 'border-blue-400' %>" data-item-status="<%- (item.originalItem && item.originalItem.status) || 'pending' %>">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 sm:w-16 sm:h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                    <% if (item.imageUrl) { %>
                      <img src="<%- item.imageUrl %>" alt="Product Image" class="w-full h-full object-cover" loading="lazy">
                    <% } else { %>
                      <div class="w-full h-full flex items-center justify-center text-gray-400">
                        <i class="fas fa-cube text-lg"></i>
                      </div>
                    <% } %>
                  </div>
                  <div class="min-w-0 flex-1">
                    <h3 class="font-medium text-gray-900 truncate"><%- item.title || 'Product Title Not Available' %></h3>
                    <p class="text-sm text-gray-600"><%- item.priceDisplay || 'Price Not Available' %></p>
                    <% if (item.originalItem && item.originalItem.variantSku) { %>
                      <p class="text-xs text-gray-500 font-mono">SKU: <%- item.originalItem.variantSku %></p>
                    <% } %>
                    <p class="text-xs text-gray-500">Qty: <%- (item.originalItem && item.originalItem.qty) || 1 %></p>
                  </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                  <span class="px-3 py-1 rounded-full text-xs sm:text-sm font-medium text-center
                    <% const status = (item.originalItem && item.originalItem.status) || 'pending'; %>
                    <% if (status === 'pending') { %>bg-yellow-100 text-yellow-800<% } %>
                    <% if (status === 'processing') { %>bg-blue-100 text-blue-800<% } %>
                    <% if (status === 'shipped') { %>bg-purple-100 text-purple-800<% } %>
                    <% if (status === 'delivered') { %>bg-green-100 text-green-800<% } %>
                    <% if (status === 'cancelled') { %>bg-red-100 text-red-800<% } %>">
                    <%- item.statusDisplay || status.charAt(0).toUpperCase() + status.slice(1) %>
                  </span>
                  <% if (item.canUpdate && status !== 'delivered' && status !== 'cancelled') { %>
                    <div class="flex flex-wrap gap-1 justify-center sm:justify-start">
                      <% if (status === 'pending') { %>
                        <button onclick="updateItemStatus(<%- index %>, 'processing')" class="item-action px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-all disabled:opacity-50">Process</button>
                      <% } %>
                      <% if (status === 'pending' || status === 'processing') { %>
                        <button onclick="updateItemStatus(<%- index %>, 'shipped')" class="item-action px-2 py-1 bg-purple-500 text-white text-xs rounded hover:bg-purple-600 transition-all disabled:opacity-50">Ship</button>
                      <% } %>
                      <% if (status === 'shipped') { %>
                        <button onclick="updateItemStatus(<%- index %>, 'delivered')" class="item-action px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition-all disabled:opacity-50">Deliver</button>
                      <% } %>
                      <button onclick="confirmItemCancel(<%- index %>)" class="item-cancel px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition-all disabled:opacity-50">Cancel</button>
                    </div>
                  <% } else { %>
                    <span class="text-xs text-gray-500 text-center"><%- (status === 'delivered' || status === 'cancelled') ? 'Final Status' : 'No Actions Available' %></span>
                  <% } %>
                </div>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="p-8 text-center text-gray-500">
            <i class="fas fa-exclamation-triangle text-4xl mb-4 text-gray-300"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No Items Found</h3>
            <p class="text-gray-600">This order appears to have no items to display.</p>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Order Details -->
    <div class="bg-white rounded-lg shadow-sm border">
      <div class="p-4 border-b">
        <h2 class="text-lg font-semibold">Order Details</h2>
      </div>
      <form method="POST" enctype="multipart/form-data" action="/admin/v1/order/<%- encodeURIComponent(order._id) %>?_method=PUT" class="p-4 space-y-4" onsubmit="return validateOrderForm()">
        <input type="hidden" name="_csrf" value="<%= locals.csrfToken || '' %>">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1" for="order-status">Order Status</label>
            <select name="status" id="order-status" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
              <% const currentStatus = order.status || 'pending'; %>
              <option value="pending" <%- currentStatus === 'pending' ? 'selected' : '' %>>Pending</option>
              <option value="processing" <%- currentStatus === 'processing' ? 'selected' : '' %>>Processing</option>
              <option value="shipped" <%- currentStatus === 'shipped' ? 'selected' : '' %>>Shipped</option>
              <option value="delivered" <%- currentStatus === 'delivered' ? 'selected' : '' %>>Delivered</option>
              <option value="cancelled" <%- currentStatus === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="payment-status">Payment Status</label>
            <select name="paid" id="payment-status" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
              <% const isPaid = order.paid === true || order.paid === 'true'; %>
              <option value="false" <%- !isPaid ? 'selected' : '' %>>Unpaid</option>
              <option value="true" <%- isPaid ? 'selected' : '' %>>Paid</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="tracking-number">Tracking Number</label>
          <input type="text" name="trackingNumber" id="tracking-number" value="<%- order.trackingNumber || '' %>" placeholder="Enter tracking number" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" maxlength="50">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="status-message">Message to Customer</label>
          <textarea name="statusMessage" id="status-message" rows="3" placeholder="Optional message to customer..." class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-vertical" maxlength="500"></textarea>
        </div>
        <div class="flex flex-col sm:flex-row gap-3">
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <i class="fas fa-save"></i>
            <span>Update Order</span>
          </button>
          <a href="/admin/v1/order/<%- encodeURIComponent(order._id) %>" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all text-center flex items-center justify-center gap-2">
            <i class="fas fa-times"></i>
            <span>Cancel</span>
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
const orderId = '<%- order._id %>';

// Form validation
function validateOrderForm() {
  const status = document.getElementById('order-status').value;
  const trackingNumber = document.getElementById('tracking-number').value.trim();
  
  if ((status === 'shipped' || status === 'delivered') && !trackingNumber) {
    return confirm('No tracking number provided. Continue anyway?');
  }
  
  return true;
}

// Confirm item cancellation
function confirmItemCancel(index) {
  if (confirm('Are you sure you want to cancel this item? This action cannot be undone.')) {
    updateItemStatus(index, 'cancelled');
  }
}

// Update item status function
function updateItemStatus(index, action) {
  const button = event.target;
  const originalText = button.textContent;
  button.disabled = true;
  button.textContent = 'Updating...';
  
  fetch(`/admin/v1/order/${orderId}/items/${index}`, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify({
      status: action,
      statusMessage: `Item ${action} by admin`,
      sendEmail: false
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert('Error: ' + (data.message || 'Unknown error occurred'));
      button.disabled = false;
      button.textContent = originalText;
    }
  })
  .catch(error => {
    console.error('Network error:', error);
    alert('Network error occurred. Please try again.');
    button.disabled = false;
    button.textContent = originalText;
  });
}
</script>

<%- include('../partials/footer.ejs') %>