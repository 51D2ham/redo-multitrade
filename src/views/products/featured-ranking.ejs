<%- include('../partials/header.ejs', { title: 'Featured Products Ranking' }) %>

<!-- Navigation Breadcrumb -->
<nav class="flex items-center gap-2 mb-8 p-4 bg-white rounded-xl shadow-sm border border-gray-100">
  <a href="/admin/v1/staff/dashboard" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100 transition">
    <i class="fa fa-home"></i> Dashboard
  </a>
  <i class="fa fa-chevron-right text-gray-400 text-sm"></i>
  <a href="/admin/v1/products" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-50 text-gray-700 hover:bg-gray-100 transition">
    <i class="fa fa-box"></i> Products
  </a>
  <i class="fa fa-chevron-right text-gray-400 text-sm"></i>
  <span class="px-4 py-2 text-gray-600 font-medium">Featured Ranking</span>
</nav>

<main class="container mx-auto px-4">
  <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 border-b border-gray-100">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 rounded-xl bg-blue-100 text-blue-700 flex items-center justify-center">
            <i class="fa fa-star text-2xl"></i>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-gray-800">Featured Products Ranking</h1>
            <p class="text-gray-600 mt-1">Drag and drop to reorder featured products</p>
          </div>
        </div>
        <div class="text-right">
          <div class="text-2xl font-bold text-blue-600"><%= products.length %></div>
          <div class="text-sm text-gray-500">Featured Products</div>
        </div>
      </div>
    </div>

    <div class="p-6">
      <!-- Flash Messages -->
      <% if (error && error.length) { %>
        <div class="mb-4 p-3 rounded-lg border-l-4 border-red-400 bg-red-50 text-red-700">
          <% error.forEach(msg => { %>
            <div class="flex items-center gap-2">
              <i class="fa fa-exclamation-circle"></i>
              <%= msg %>
            </div>
          <% }) %>
        </div>
      <% } %>
      <% if (success && success.length) { %>
        <div class="mb-4 p-3 rounded-lg border-l-4 border-green-400 bg-green-50 text-green-700">
          <% success.forEach(msg => { %>
            <div class="flex items-center gap-2">
              <i class="fa fa-check-circle"></i>
              <%= msg %>
            </div>
          <% }) %>
        </div>
      <% } %>

      <% if (products.length === 0) { %>
        <div class="text-center py-12">
          <div class="w-24 h-24 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
            <i class="fa fa-star text-3xl text-gray-400"></i>
          </div>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">No Featured Products</h3>
          <p class="text-gray-500 mb-4">Mark products as featured to manage their ranking here.</p>
          <a href="/admin/v1/products" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
            <i class="fa fa-plus"></i> Manage Products
          </a>
        </div>
      <% } else { %>
        <form id="rankingForm" action="/admin/v1/products/featured/update-ranking" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          
          <div class="mb-4 flex items-center justify-between">
            <div class="text-sm text-gray-600">
              <i class="fa fa-info-circle text-blue-500"></i>
              Drag products to reorder. Higher positions appear first on the website.
            </div>
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2">
              <i class="fa fa-save"></i> Save Ranking
            </button>
          </div>

          <div id="sortableList" class="space-y-3">
            <% products.forEach((product, index) => { %>
              <div class="ranking-item bg-gray-50 rounded-lg p-4 border border-gray-200 cursor-move hover:bg-gray-100 transition" data-id="<%= product._id %>">
                <div class="flex items-center gap-4">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center font-semibold text-sm">
                      <span class="rank-number"><%= index + 1 %></span>
                    </div>
                    <i class="fa fa-grip-vertical text-gray-400"></i>
                  </div>
                  
                  <div class="flex-shrink-0">
                    <% if (product.images && product.images.length > 0) { %>
                      <img src="/uploads/products/<%= product.images[0] %>" alt="<%= product.title %>" class="w-16 h-16 object-cover rounded-lg">
                    <% } else { %>
                      <div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                        <i class="fa fa-image text-gray-400"></i>
                      </div>
                    <% } %>
                  </div>
                  
                  <div class="flex-1 min-w-0">
                    <h3 class="font-semibold text-gray-800 truncate"><%= product.title %></h3>
                    <div class="flex items-center gap-4 mt-1 text-sm text-gray-600">
                      <span class="flex items-center gap-1">
                        <i class="fa fa-tag"></i>
                        <%= product.category?.name || 'No Category' %>
                      </span>
                      <span class="flex items-center gap-1">
                        <i class="fa fa-building"></i>
                        <%= product.brand?.name || 'No Brand' %>
                      </span>
                      <span class="flex items-center gap-1">
                        <i class="fa fa-boxes"></i>
                        <%= product.totalStock %> in stock
                      </span>
                    </div>
                  </div>
                  
                  <div class="flex items-center gap-2">
                    <span class="px-2 py-1 text-xs rounded-full <%= product.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700' %>">
                      <%= product.status %>
                    </span>
                    <a href="/admin/v1/products/<%= product._id %>" class="p-2 text-gray-400 hover:text-blue-600 transition">
                      <i class="fa fa-external-link-alt"></i>
                    </a>
                  </div>
                </div>
              </div>
            <% }) %>
          </div>
        </form>
      <% } %>
    </div>
  </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const sortableList = document.getElementById('sortableList');
  
  if (sortableList) {
    // Simple drag and drop without external library
    let draggedElement = null;
    
    // Add drag functionality to each item
    const items = sortableList.querySelectorAll('.ranking-item');
    items.forEach(item => {
      item.draggable = true;
      
      item.addEventListener('dragstart', function(e) {
        draggedElement = this;
        this.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
      });
      
      item.addEventListener('dragend', function(e) {
        this.style.opacity = '';
        draggedElement = null;
        updateRankNumbers();
      });
      
      item.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      });
      
      item.addEventListener('drop', function(e) {
        e.preventDefault();
        if (draggedElement !== this) {
          const rect = this.getBoundingClientRect();
          const midpoint = rect.top + rect.height / 2;
          
          if (e.clientY < midpoint) {
            this.parentNode.insertBefore(draggedElement, this);
          } else {
            this.parentNode.insertBefore(draggedElement, this.nextSibling);
          }
        }
      });
    });
    
    function updateRankNumbers() {
      const items = sortableList.querySelectorAll('.ranking-item');
      items.forEach((item, index) => {
        const rankNumber = item.querySelector('.rank-number');
        if (rankNumber) {
          rankNumber.textContent = index + 1;
        }
      });
    }
    
    document.getElementById('rankingForm').addEventListener('submit', function(e) {
      const items = sortableList.querySelectorAll('.ranking-item');
      const rankings = Array.from(items).map(item => ({
        id: item.dataset.id
      }));
      
      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = 'rankings';
      hiddenInput.value = JSON.stringify(rankings);
      this.appendChild(hiddenInput);
    });
  }
});
</script>

<%- include('../partials/footer.ejs') %>